
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mask R-CNN - Inspect Trained Model &#8212; Introduction to Artificial Intelligence</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../../../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../../../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model';</script>
    <link rel="canonical" href="https://pantelis.github.io/artificial-intelligence/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.html" />
    <link rel="icon" href="../../../../../_static/logo.ico"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Mask R-CNN - Inspect Weights of a Trained Model" href="inspect_weights.html" />
    <link rel="prev" title="Mask R-CNN - Inspect Training Data" href="inspect_data.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../../_static/logo.png" class="logo__image only-light" alt="Introduction to Artificial Intelligence - Home"/>
    <script>document.write(`<img src="../../../../../_static/logo.png" class="logo__image only-dark" alt="Introduction to Artificial Intelligence - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="list-caption"><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Supervised Learning-1</span></p><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="label-parts" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../regression/linear-regression/linear_regression.html">Linear Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../entropy/index.html">Entropy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization/maximum-likelihood/marginal_maximum_likelihood.html">Maximum Likelihood Estimation of a marginal model</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../optimization/maximum-likelihood/mle-gaussian-parameters.html">Maximum Likelihood Estimation of Gaussian Parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization/maximum-likelihood/conditional_maximum_likelihood.html">Maximum Likelihood (ML) Estimation of conditional models</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Deep Neural Networks</span></p><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="label-parts" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../dnn/dnn-intro/index.html">Deep Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dnn/fashion-mnist-case-study.html">Fashion MNIST Case Study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../optimization/regularization/regularization-workshop-1.html">Regularization Workshop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../information-theory-dnn/index.html">Fusion of Statistical Learning Theory, Information Theory and Stochastic Optimization</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Convolutional Neural Networks</span></p><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="label-parts" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../cnn/cnn-example-architectures/using_convnets_with_small_datasets.html">Using convnets with small datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cnn/cnn-example-architectures/visualizing-what-convnets-learn.html">Visualizing what convnets learn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature-extraction-resnet/index.html">Feature Extraction via Residual Networks</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Scene Understanding</span></p><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="label-parts" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../scene-understanding-intro/index.html">Introduction to Scene Understanding</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../object-detection/object-detection-intro/index.html">Object Detection</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../object-detection/detection-metrics/index.html">Object Detection and Semantic Segmentation Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../object-detection/rcnn-object-detection/index.html">Region-CNN (RCNN) Object Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../object-detection/faster-rcnn-object-detection/index.html">Fast and Faster RCNN Object Detection</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../index.html">Object Det. &amp; Semantic Segm. Workshop</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html">Mask R-CNN Semantic Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="demo.html">Mask R-CNN Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="inspect_data.html">Mask R-CNN - Inspect Training Data</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Mask R-CNN - Inspect Trained Model</a></li>










<li class="toctree-l2"><a class="reference internal" href="inspect_weights.html">Mask R-CNN - Inspect Weights of a Trained Model</a></li>





<li class="toctree-l2"><a class="reference internal" href="detectron2_tutorial.html">Detectron2 Beginner’s Tutorial</a></li>





</ul>
</li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Transfer Learning</span></p><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="label-parts" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../transfer-learning/transfer-learning-introduction.html">Introduction to Transfer Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../transfer-learning/transfer_learning_tutorial.html">Transfer Learning for Computer Vision Tutorial</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Probabilistic Reasoning</span></p><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="label-parts" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../rse/recursive-state-estimation/index.html">Recursive State Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rse/discrete-bayesian-filter/discrete-bayesian-filter.html">Discrete Bayes Filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rse/kalman-filters/one-dimensional-kalman-filters.html">Kalman Filters</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Logical Reasoning</span></p><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="label-parts" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../logical-reasoning/logical-inference/index.html">Logical Inference</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Planning without Interactions</span></p><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="label-parts" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../planning/index.html">Automated Planning</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../planning/pddl/index.html">PDDL</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/pddl/blocksworld/up_blocksworld_demo.html">The Unified Planning Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/pddl/logistics/index.html">Logistics Planning in PDDL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/pddl/manufacturing/index.html">Manufacrturing Robot Planning in PDDL</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../planning/search/index.html">Search Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/search/forward-search/index.html">Forward Search Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/search/a-star/index.html">The A* Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../planning/search/search-alg-demo/index.html">Interactive Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../motion-planning-cars/index.html">Motion Planning for Autonomous Cars</a></li>
</ul>
</li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Markov Decision Processes</span></p><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="label-parts" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../mdp/index.html">Markov Decision Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mdp/mdp-intro/mdp_intro.html">Introduction to MDP</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../mdp/dynamic-programming-algorithms/index.html">Dynamic Programming Algorithms</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mdp/dynamic-programming-algorithms/value-iteration/index.html">Value Iteration</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../mdp/mdp-workshop/index.html">MDP Workshop</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mdp/mdp-workshop/cleaning-robot/deterministic_mdp.html">Cleaning Robot - Deterministic MDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mdp/mdp-workshop/cleaning-robot/stochastic_mdp.html">Cleaning Robot - Stochastic MDP</a></li>
</ul>
</li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Reinforcement Learning</span></p><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="label-parts" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../reinforcement-learning/prediction/monte-carlo.html">Monte-Carlo Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reinforcement-learning/prediction/temporal-difference.html">Temporal Difference (TD) Prediction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../reinforcement-learning/model-free-control/index.html">Model-free Control</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reinforcement-learning/model-free-control/generalized-policy-iteration/index.html">Generalized Policy Iteration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reinforcement-learning/model-free-control/greedy-monte-carlo/index.html"><span class="math notranslate nohighlight">\(\epsilon\)</span>-greedy Monte-Carlo (MC) Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reinforcement-learning/model-free-control/sarsa/index.html">The SARSA Algorithm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reinforcement-learning/model-free-control/sarsa/gridworld/sarsa_gridworld.html">SARSA Gridworld Example</a></li>
</ul>
</li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Sequences and RNNs</span></p><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="label-parts" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../rnn/time_series_using_simple_rnn_lstm.html">Time Series Prediction using RNNs</a></li>





</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Natural Language Processing</span></p><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="label-parts" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/nlp-introduction/tokenization/index.html">Tokenization</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../nlp/nmt/nmt-intro/index.html">Neural Machine Translation</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/nmt/nmt-metrics/index.html">NMT Metrics  - BLEU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/nmt/rnn-nmt-attention/index.html">Attention in RNN-based NMT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/nmt/rnn-attention-workshop/seq2seq_and_attention.html">Attention in RNN NMT Workshop</a></li>




</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../nlp/transformers/transformers-intro.html">Transformers and Self-attention</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/transformers/singlehead-self-attention.html">Single-head self-attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/transformers/multihead-self-attention.html">Multi-head self-attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../nlp/transformers/positional_embeddings.html">Positional Embeddings</a></li>
</ul>
</li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Math Background</span></p><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="label-parts" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../ml-math/index.html">Math for ML Textbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ml-math/probability/index.html">Probability Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ml-math/linear-algebra/index.html">Linear Algebra for Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ml-math/calculus/index.html">Calculus</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/><label class="label-parts" for="toctree-checkbox-23"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/environment/index.html">Your Programming Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/environment/slurm-keras-example.html">Training Keras with the SLURM Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/environment/nyu-jupyterhub-envs.html">NYU JupyrterHub Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/environment/assignment-submission.html">Submitting Your Assignment / Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python/index.html">Learn Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/environment/notebook-status.html">Notebook execution status</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">CS-GY-6613 / CS370 Common Assignments</span></p><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/><label class="label-parts" for="toctree-checkbox-24"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/probability/probability-assignment-8/index.html">Probability &amp; Linear Algebra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/optimization/sgd.html">Stochastic Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/object-detection/video-search.html">Video Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/object-tracking-kalman/drone-follow-me.html">Drone follow me using Kalman Filters</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">CS-GY-6613-INET-Assignments</span></p><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/><label class="label-parts" for="toctree-checkbox-25"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/probability/probability-assignment-3/index.html">Probability Assignment</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/optimization/sgd-linear-regression/index.html">Optimization algorithms for linear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/object-detection/video-search2.html">Video Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../assignments/object-tracking-kalman/drone-follow-me2.html">Drone follow me using Kalman Filters</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Undergraduate Project</span></p><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/><label class="label-parts" for="toctree-checkbox-26"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../projects/cv/sam-finetuning-remote-sensing/index.html">Segment Anything Model Finetuning for Remote Sensing Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects/robotics/learning-in-simulated-worlds/index.html">Learning in Simulated Worlds</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects/cv/wasm-pipelines/index.html">Webassembly (WASM) media pipelines</a></li>
</ul></li><li class="toctree-l0 has-children"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Graduate Projects</span></p><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" type="checkbox"/><label class="label-parts" for="toctree-checkbox-27"><i class="fa-solid fa-chevron-down"></i></label><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../projects/cv/sam-advanced-remote-sensing/index.html">Visual Prompting and Oclusion Handling for Remote Sensing Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../projects/robotics/nl-guided-robotics/index.html">Natual Language Guided Robotics</a></li>
</ul></li></ul>
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/pantelis/artificial-intelligence/master?urlpath=tree/artificial_intelligence/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/pantelis/artificial-intelligence/blob/master/artificial_intelligence/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../../../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/pantelis/artificial-intelligence" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/pantelis/artificial-intelligence/issues/new?title=Issue%20on%20page%20%2Faiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../../../_sources/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Mask R-CNN - Inspect Trained Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Mask R-CNN - Inspect Trained Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configurations">Configurations</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-preferences">Notebook Preferences</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-validation-dataset">Load Validation Dataset</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-model">Load Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#run-detection">Run Detection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall">Precision-Recall</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-map-iou-50-on-batch-of-images">Compute mAP @ IoU=50 on Batch of Images</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#step-by-step-prediction">Step by Step Prediction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-region-proposal-network">Stage 1: Region Proposal Network</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-rpn-targets">1.a RPN Targets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-rpn-predictions">1.b RPN Predictions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-2-proposal-classification">Stage 2: Proposal Classification</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-proposal-classification">2.a Proposal Classification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-step-by-step-detection">2.c Step by Step Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-bounding-box-refinement">Apply Bounding Box Refinement</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-low-confidence-detections">Filter Low Confidence Detections</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#per-class-non-max-suppression">Per-Class Non-Max Suppression</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-3-generating-masks">Stage 3: Generating Masks</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-mask-targets">3.a Mask Targets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-predicted-masks">3.b Predicted Masks</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-activations">Visualize Activations</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="mask-r-cnn-inspect-trained-model">
<h1>Mask R-CNN - Inspect Trained Model<a class="headerlink" href="#mask-r-cnn-inspect-trained-model" title="Link to this heading">#</a></h1>
<p>Code and visualizations to test, debug, and evaluate the Mask R-CNN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>

<span class="c1"># Root directory of the project</span>
<span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;../../&quot;</span><span class="p">)</span>

<span class="c1"># Import Mask RCNN</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>  <span class="c1"># To find local version of the library</span>
<span class="kn">from</span> <span class="nn">mrcnn</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">mrcnn</span> <span class="kn">import</span> <span class="n">visualize</span>
<span class="kn">from</span> <span class="nn">mrcnn.visualize</span> <span class="kn">import</span> <span class="n">display_images</span>
<span class="kn">import</span> <span class="nn">mrcnn.model</span> <span class="k">as</span> <span class="nn">modellib</span>
<span class="kn">from</span> <span class="nn">mrcnn.model</span> <span class="kn">import</span> <span class="n">log</span>

<span class="o">%</span><span class="k">matplotlib</span> inline 

<span class="c1"># Directory to save logs and trained model</span>
<span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>

<span class="c1"># Local path to trained weights file</span>
<span class="n">COCO_MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;mask_rcnn_coco.h5&quot;</span><span class="p">)</span>
<span class="c1"># Download COCO trained weights from Releases if needed</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">COCO_MODEL_PATH</span><span class="p">):</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">download_trained_weights</span><span class="p">(</span><span class="n">COCO_MODEL_PATH</span><span class="p">)</span>

<span class="c1"># Path to Shapes trained weights</span>
<span class="n">SHAPES_MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;mask_rcnn_shapes.h5&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using TensorFlow backend.
</pre></div>
</div>
</div>
</div>
</section>
<section id="configurations">
<h1>Configurations<a class="headerlink" href="#configurations" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run one of the code blocks</span>

<span class="c1"># Shapes toy dataset</span>
<span class="c1"># import shapes</span>
<span class="c1"># config = shapes.ShapesConfig()</span>

<span class="c1"># MS COCO Dataset</span>
<span class="kn">import</span> <span class="nn">coco</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">CocoConfig</span><span class="p">()</span>
<span class="n">COCO_DIR</span> <span class="o">=</span> <span class="s2">&quot;path to COCO dataset&quot;</span>  <span class="c1"># TODO: enter value here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Override the training configurations with a few</span>
<span class="c1"># changes for inferencing.</span>
<span class="k">class</span> <span class="nc">InferenceConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
    <span class="c1"># Run detection on one image at a time</span>
    <span class="n">GPU_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IMAGES_PER_GPU</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">InferenceConfig</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configurations:
BACKBONE_SHAPES                [[256 256]
 [128 128]
 [ 64  64]
 [ 32  32]
 [ 16  16]]
BACKBONE_STRIDES               [4, 8, 16, 32, 64]
BATCH_SIZE                     1
BBOX_STD_DEV                   [ 0.1  0.1  0.2  0.2]
DETECTION_MAX_INSTANCES        100
DETECTION_MIN_CONFIDENCE       0.5
DETECTION_NMS_THRESHOLD        0.3
GPU_COUNT                      1
IMAGES_PER_GPU                 1
IMAGE_MAX_DIM                  1024
IMAGE_MIN_DIM                  800
IMAGE_PADDING                  True
IMAGE_SHAPE                    [1024 1024    3]
LEARNING_MOMENTUM              0.9
LEARNING_RATE                  0.002
MASK_POOL_SIZE                 14
MASK_SHAPE                     [28, 28]
MAX_GT_INSTANCES               100
MEAN_PIXEL                     [ 123.7  116.8  103.9]
MINI_MASK_SHAPE                (56, 56)
NAME                           coco
NUM_CLASSES                    81
POOL_SIZE                      7
POST_NMS_ROIS_INFERENCE        1000
POST_NMS_ROIS_TRAINING         2000
ROI_POSITIVE_RATIO             0.33
RPN_ANCHOR_RATIOS              [0.5, 1, 2]
RPN_ANCHOR_SCALES              (32, 64, 128, 256, 512)
RPN_ANCHOR_STRIDE              2
RPN_BBOX_STD_DEV               [ 0.1  0.1  0.2  0.2]
RPN_TRAIN_ANCHORS_PER_IMAGE    256
STEPS_PER_EPOCH                1000
TRAIN_ROIS_PER_IMAGE           128
USE_MINI_MASK                  True
USE_RPN_ROIS                   True
VALIDATION_STEPS               50
WEIGHT_DECAY                   0.0001
</pre></div>
</div>
</div>
</div>
</section>
<section id="notebook-preferences">
<h1>Notebook Preferences<a class="headerlink" href="#notebook-preferences" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Device to load the neural network on.</span>
<span class="c1"># Useful if you&#39;re training a model on the same </span>
<span class="c1"># machine, in which case use CPU and leave the</span>
<span class="c1"># GPU for training.</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;/cpu:0&quot;</span>  <span class="c1"># /cpu:0 or /gpu:0</span>

<span class="c1"># Inspect the model in training or inference modes</span>
<span class="c1"># values: &#39;inference&#39; or &#39;training&#39;</span>
<span class="c1"># TODO: code for &#39;training&#39; test mode not ready yet</span>
<span class="n">TEST_MODE</span> <span class="o">=</span> <span class="s2">&quot;inference&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ax</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a Matplotlib Axes array to be used in</span>
<span class="sd">    all visualizations in the notebook. Provide a</span>
<span class="sd">    central point to control graph sizes.</span>
<span class="sd">    </span>
<span class="sd">    Adjust the size attribute to control how big to render images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-validation-dataset">
<h1>Load Validation Dataset<a class="headerlink" href="#load-validation-dataset" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build validation dataset</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s1">&#39;shapes&#39;</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">ShapesDataset</span><span class="p">()</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">load_shapes</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">CocoDataset</span><span class="p">()</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">load_coco</span><span class="p">(</span><span class="n">COCO_DIR</span><span class="p">,</span> <span class="s2">&quot;minival&quot;</span><span class="p">)</span>

<span class="c1"># Must call before using the dataset</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Images: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Classes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">),</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loading annotations into memory...
Done (t=4.86s)
creating index...
index created!
Images: 35185
Classes: [&#39;BG&#39;, &#39;person&#39;, &#39;bicycle&#39;, &#39;car&#39;, &#39;motorcycle&#39;, &#39;airplane&#39;, &#39;bus&#39;, &#39;train&#39;, &#39;truck&#39;, &#39;boat&#39;, &#39;traffic light&#39;, &#39;fire hydrant&#39;, &#39;stop sign&#39;, &#39;parking meter&#39;, &#39;bench&#39;, &#39;bird&#39;, &#39;cat&#39;, &#39;dog&#39;, &#39;horse&#39;, &#39;sheep&#39;, &#39;cow&#39;, &#39;elephant&#39;, &#39;bear&#39;, &#39;zebra&#39;, &#39;giraffe&#39;, &#39;backpack&#39;, &#39;umbrella&#39;, &#39;handbag&#39;, &#39;tie&#39;, &#39;suitcase&#39;, &#39;frisbee&#39;, &#39;skis&#39;, &#39;snowboard&#39;, &#39;sports ball&#39;, &#39;kite&#39;, &#39;baseball bat&#39;, &#39;baseball glove&#39;, &#39;skateboard&#39;, &#39;surfboard&#39;, &#39;tennis racket&#39;, &#39;bottle&#39;, &#39;wine glass&#39;, &#39;cup&#39;, &#39;fork&#39;, &#39;knife&#39;, &#39;spoon&#39;, &#39;bowl&#39;, &#39;banana&#39;, &#39;apple&#39;, &#39;sandwich&#39;, &#39;orange&#39;, &#39;broccoli&#39;, &#39;carrot&#39;, &#39;hot dog&#39;, &#39;pizza&#39;, &#39;donut&#39;, &#39;cake&#39;, &#39;chair&#39;, &#39;couch&#39;, &#39;potted plant&#39;, &#39;bed&#39;, &#39;dining table&#39;, &#39;toilet&#39;, &#39;tv&#39;, &#39;laptop&#39;, &#39;mouse&#39;, &#39;remote&#39;, &#39;keyboard&#39;, &#39;cell phone&#39;, &#39;microwave&#39;, &#39;oven&#39;, &#39;toaster&#39;, &#39;sink&#39;, &#39;refrigerator&#39;, &#39;book&#39;, &#39;clock&#39;, &#39;vase&#39;, &#39;scissors&#39;, &#39;teddy bear&#39;, &#39;hair drier&#39;, &#39;toothbrush&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-model">
<h1>Load Model<a class="headerlink" href="#load-model" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create model in inference mode</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">MODEL_DIR</span><span class="p">,</span>
                              <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Set weights file path</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">SHAPES_MODEL_PATH</span>
<span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">COCO_MODEL_PATH</span>
<span class="c1"># Or, uncomment to load the last model you trained</span>
<span class="c1"># weights_path = model.find_last()</span>

<span class="c1"># Load weights</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading weights &quot;</span><span class="p">,</span> <span class="n">weights_path</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-detection">
<h1>Run Detection<a class="headerlink" href="#run-detection" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">)</span>
<span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span>\
    <span class="n">modellib</span><span class="o">.</span><span class="n">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">image_info</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image ID: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">image_id</span><span class="p">,</span> 
                                       <span class="n">dataset</span><span class="o">.</span><span class="n">image_reference</span><span class="p">(</span><span class="n">image_id</span><span class="p">)))</span>
<span class="c1"># Run object detection</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">detect</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display results</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">get_ax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> 
                            <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_class_id&quot;</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_bbox&quot;</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_mask&quot;</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image ID: coco.392144 (34940) http://cocodataset.org/#explore?id=392144
Processing 1 images
image                    shape: (1024, 1024, 3)       min:    0.00000  max:  255.00000
molded_images            shape: (1, 1024, 1024, 3)    min: -123.70000  max:  151.10000
image_metas              shape: (1, 89)               min:    0.00000  max: 1024.00000
gt_class_id              shape: (10,)                 min:    1.00000  max:   40.00000
gt_bbox                  shape: (10, 5)               min:    0.00000  max: 1024.00000
gt_mask                  shape: (1024, 1024, 10)      min:    0.00000  max:    1.00000
</pre></div>
</div>
<img alt="../../../../../_images/ec4ee674522b7f95cd6f68fc5bf7a29591a7ec294865f605d71a657d3a2c6e85.png" src="../../../../../_images/ec4ee674522b7f95cd6f68fc5bf7a29591a7ec294865f605d71a657d3a2c6e85.png" />
</div>
</div>
<section id="precision-recall">
<h2>Precision-Recall<a class="headerlink" href="#precision-recall" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Draw precision-recall curve</span>
<span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_ap</span><span class="p">(</span><span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span>
                                          <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">plot_precision_recall</span><span class="p">(</span><span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/341f9670f21bbe2f82422f9ed16a1bf150954f2d089dbeabb88ba0a9abff54ec.png" src="../../../../../_images/341f9670f21bbe2f82422f9ed16a1bf150954f2d089dbeabb88ba0a9abff54ec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grid of ground truth objects and their predictions</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">plot_overlaps</span><span class="p">(</span><span class="n">gt_class_id</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span>
                        <span class="n">overlaps</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/c8c91b9276d3c8c4875067d7e5c56dd169294b88fbac187760856ba75db3c475.png" src="../../../../../_images/c8c91b9276d3c8c4875067d7e5c56dd169294b88fbac187760856ba75db3c475.png" />
</div>
</div>
</section>
<section id="compute-map-iou-50-on-batch-of-images">
<h2>Compute mAP &#64; IoU=50 on Batch of Images<a class="headerlink" href="#compute-map-iou-50-on-batch-of-images" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute VOC-style Average Precision</span>
<span class="k">def</span> <span class="nf">compute_batch_ap</span><span class="p">(</span><span class="n">image_ids</span><span class="p">):</span>
    <span class="n">APs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
        <span class="c1"># Load image</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span>\
            <span class="n">modellib</span><span class="o">.</span><span class="n">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
                                   <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Run object detection</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">detect</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Compute AP</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span>\
            <span class="n">utils</span><span class="o">.</span><span class="n">compute_ap</span><span class="p">(</span><span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span>
                              <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span>
        <span class="n">APs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AP</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">APs</span>

<span class="c1"># Pick a set of random images</span>
<span class="n">image_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">APs</span> <span class="o">=</span> <span class="n">compute_batch_ap</span><span class="p">(</span><span class="n">image_ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mAP @ IoU=50: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">APs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mAP @ IoU=50:  0.656323084916
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.5/dist-packages/scipy/ndimage/interpolation.py:600: UserWarning: From scipy 0.13.0, the output shape of zoom() is calculated with round() instead of int() - for these inputs the size of the returned array has changed.
  &quot;the returned array has changed.&quot;, UserWarning)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="step-by-step-prediction">
<h1>Step by Step Prediction<a class="headerlink" href="#step-by-step-prediction" title="Link to this heading">#</a></h1>
</section>
<section id="stage-1-region-proposal-network">
<h1>Stage 1: Region Proposal Network<a class="headerlink" href="#stage-1-region-proposal-network" title="Link to this heading">#</a></h1>
<p>The Region Proposal Network (RPN) runs a lightweight binary classifier on a lot of boxes (anchors) over the image and returns object/no-object scores. Anchors with high <em>objectness</em> score (positive anchors) are passed to the stage two to be classified.</p>
<p>Often, even positive anchors don’t cover objects fully. So the RPN also regresses a refinement (a delta in location and size) to be applied to the anchors to shift it and resize it a bit to the correct boundaries of the object.</p>
<section id="a-rpn-targets">
<h2>1.a RPN Targets<a class="headerlink" href="#a-rpn-targets" title="Link to this heading">#</a></h2>
<p>The RPN targets are the training values for the RPN. To generate the targets, we start with a grid of anchors that cover the full image at different scales, and then we compute the IoU of the anchors with ground truth object. Positive anchors are those that have an IoU &gt;= 0.7 with any ground truth object, and negative anchors are those that don’t cover any object by more than 0.3 IoU. Anchors in between (i.e. cover an object by IoU &gt;= 0.3 but &lt; 0.7) are considered neutral and excluded from training.</p>
<p>To train the RPN regressor, we also compute the shift and resizing needed to make the anchor cover the ground truth object completely.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate RPN trainig targets</span>
<span class="c1"># target_rpn_match is 1 for positive anchors, -1 for negative anchors</span>
<span class="c1"># and 0 for neutral anchors.</span>
<span class="n">target_rpn_match</span><span class="p">,</span> <span class="n">target_rpn_bbox</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">build_rpn_targets</span><span class="p">(</span>
    <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;target_rpn_match&quot;</span><span class="p">,</span> <span class="n">target_rpn_match</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;target_rpn_bbox&quot;</span><span class="p">,</span> <span class="n">target_rpn_bbox</span><span class="p">)</span>

<span class="n">positive_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">negative_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">neutral_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">positive_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">positive_anchor_ix</span><span class="p">]</span>
<span class="n">negative_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">negative_anchor_ix</span><span class="p">]</span>
<span class="n">neutral_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">neutral_anchor_ix</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;positive_anchors&quot;</span><span class="p">,</span> <span class="n">positive_anchors</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;negative_anchors&quot;</span><span class="p">,</span> <span class="n">negative_anchors</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;neutral anchors&quot;</span><span class="p">,</span> <span class="n">neutral_anchors</span><span class="p">)</span>

<span class="c1"># Apply refinement deltas to positive anchors</span>
<span class="n">refined_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">apply_box_deltas</span><span class="p">(</span>
    <span class="n">positive_anchors</span><span class="p">,</span>
    <span class="n">target_rpn_bbox</span><span class="p">[:</span><span class="n">positive_anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">RPN_BBOX_STD_DEV</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">,</span> <span class="n">refined_anchors</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>target_rpn_match         shape: (65472,)              min:   -1.00000  max:    1.00000
target_rpn_bbox          shape: (256, 4)              min:   -5.19860  max:    2.59641
positive_anchors         shape: (14, 4)               min:    5.49033  max:  973.25483
negative_anchors         shape: (242, 4)              min:  -22.62742  max: 1038.62742
neutral anchors          shape: (65216, 4)            min: -362.03867  max: 1258.03867
refined_anchors          shape: (14, 4)               min:    0.00000  max: 1023.99994
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display positive anchors before refinement (dotted) and</span>
<span class="c1"># after refinement (solid).</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">positive_anchors</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/d7c754b339f5d2576673c9865374423ba09bda52b24b0bbc849a5f02a9a96c55.png" src="../../../../../_images/d7c754b339f5d2576673c9865374423ba09bda52b24b0bbc849a5f02a9a96c55.png" />
</div>
</div>
</section>
<section id="b-rpn-predictions">
<h2>1.b RPN Predictions<a class="headerlink" href="#b-rpn-predictions" title="Link to this heading">#</a></h2>
<p>Here we run the RPN graph and display its predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run RPN sub-graph</span>
<span class="n">pillar</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>  <span class="c1"># node to start searching from</span>

<span class="c1"># TF 1.4 and 1.9 introduce new versions of NMS. Search for all names to support TF 1.3~1.10</span>
<span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression:0&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">nms_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression/NonMaxSuppressionV2:0&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">nms_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#TF 1.9-1.10</span>
    <span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression/NonMaxSuppressionV3:0&quot;</span><span class="p">)</span>

<span class="n">rpn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;rpn_class&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;rpn_class&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;pre_nms_anchors&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/pre_nms_anchors:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/refined_anchors:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;refined_anchors_clipped&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/refined_anchors_clipped:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;post_nms_anchor_ix&quot;</span><span class="p">,</span> <span class="n">nms_node</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;proposals&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rpn_class                shape: (1, 65472, 2)         min:    0.00000  max:    1.00000
pre_nms_anchors          shape: (1, 10000, 4)         min: -362.03867  max: 1258.03870
refined_anchors          shape: (1, 10000, 4)         min: -1385.67920  max: 2212.44043
refined_anchors_clipped  shape: (1, 10000, 4)         min:    0.00000  max: 1024.00000
post_nms_anchor_ix       shape: (1000,)               min:    0.00000  max: 1477.00000
proposals                shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show top anchors by score (before refinement)</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sorted_anchor_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;rpn_class&#39;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">sorted_anchor_ids</span><span class="p">[:</span><span class="n">limit</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/e30973979f59216e71761b900b4b5154f761846dcc7001006e6e3c2e52925a67.png" src="../../../../../_images/e30973979f59216e71761b900b4b5154f761846dcc7001006e6e3c2e52925a67.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show top anchors with refinement. Then with clipping to image boundaries</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">get_ax</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pre_nms_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;pre_nms_anchors&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">refined_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">refined_anchors_clipped</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;refined_anchors_clipped&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">pre_nms_anchors</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span>
                     <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors_clipped</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/3c73f8f4ec47b6556c7c129d7d5b42fc0e7bb4043120a09855b5cf27846aca56.png" src="../../../../../_images/3c73f8f4ec47b6556c7c129d7d5b42fc0e7bb4043120a09855b5cf27846aca56.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show refined anchors after non-max suppression</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;post_nms_anchor_ix&quot;</span><span class="p">][:</span><span class="n">limit</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors_clipped</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/2d0fc80d3f7eb03a3ff8817456c2e102dfad8c4f56573382da896a447c42205d.png" src="../../../../../_images/2d0fc80d3f7eb03a3ff8817456c2e102dfad8c4f56573382da896a447c42205d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show final proposals</span>
<span class="c1"># These are the same as the previous step (refined anchors </span>
<span class="c1"># after NMS) but with coordinates normalized to [0, 1] range.</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="c1"># Convert back to image coordinates for display</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">proposals</span> <span class="o">=</span> <span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;proposals&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">limit</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/aa07ed291a5e90e6acfb26201fa2e238a663c5ef65b3ec353cfc5a596ad0341d.png" src="../../../../../_images/aa07ed291a5e90e6acfb26201fa2e238a663c5ef65b3ec353cfc5a596ad0341d.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measure the RPN recall (percent of objects covered by anchors)</span>
<span class="c1"># Here we measure recall for 3 different methods:</span>
<span class="c1"># - All anchors</span>
<span class="c1"># - All refined anchors</span>
<span class="c1"># - Refined anchors after NMS</span>
<span class="n">iou_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All Anchors (</span><span class="si">{:5}</span><span class="s2">)       Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;refined_anchors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refined Anchors (</span><span class="si">{:5}</span><span class="s2">)   Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;refined_anchors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Post NMS Anchors (</span><span class="si">{:5}</span><span class="s2">)  Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>All Anchors (65472)       Recall: 0.400  Positive anchors: 8
Refined Anchors (10000)   Recall: 0.900  Positive anchors: 65
Post NMS Anchors (   50)  Recall: 0.800  Positive anchors: 9
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="stage-2-proposal-classification">
<h1>Stage 2: Proposal Classification<a class="headerlink" href="#stage-2-proposal-classification" title="Link to this heading">#</a></h1>
<p>This stage takes the region proposals from the RPN and classifies them.</p>
<section id="a-proposal-classification">
<h2>2.a Proposal Classification<a class="headerlink" href="#a-proposal-classification" title="Link to this heading">#</a></h2>
<p>Run the classifier heads on proposals to generate class propbabilities and bounding box regressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get input and output to classifier and mask heads.</span>
<span class="n">mrcnn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;proposals&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;probs&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_class&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;deltas&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_bbox&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;detections&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_detection&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>proposals                shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
probs                    shape: (1, 1000, 81)         min:    0.00000  max:    0.99999
deltas                   shape: (1, 1000, 81, 4)      min:   -3.26400  max:    3.83929
masks                    shape: (1, 100, 28, 28, 81)  min:    0.00000  max:    0.99984
detections               shape: (1, 100, 6)           min:    0.00000  max:  844.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get detection class IDs. Trim zero padding.</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">det_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">det_class_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">det_class_ids</span><span class="p">[:</span><span class="n">det_count</span><span class="p">]</span>
<span class="n">detections</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">det_count</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> detections: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">det_count</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">det_class_ids</span><span class="p">]))</span>

<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">detections</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> 
    <span class="n">refined_boxes</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
    <span class="n">visibilities</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">),</span>
    <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Detections&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8 detections: [&#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;airplane&#39; &#39;airplane&#39; &#39;car&#39;]
</pre></div>
</div>
<img alt="../../../../../_images/0f33bc3cfaa1a2b9b9d0a6a59a1ac18ee32e1585694025aa4e80a4700854eab6.png" src="../../../../../_images/0f33bc3cfaa1a2b9b9d0a6a59a1ac18ee32e1585694025aa4e80a4700854eab6.png" />
</div>
</div>
</section>
<section id="c-step-by-step-detection">
<h2>2.c Step by Step Detection<a class="headerlink" href="#c-step-by-step-detection" title="Link to this heading">#</a></h2>
<p>Here we dive deeper into the process of processing the detections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Proposals are in normalized coordinates. Scale them</span>
<span class="c1"># to image coordinates.</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">proposals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;proposals&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># Class ID, score, and mask per proposal</span>
<span class="n">roi_class_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;probs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">roi_scores</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;probs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">roi_class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">roi_positive_ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># How many ROIs vs empty rows?</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Valid proposals out of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Positive ROIs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_positive_ixs</span><span class="p">)))</span>

<span class="c1"># Class counts</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">roi_class_names</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000 Valid proposals out of 1000
71 Positive ROIs
[(&#39;BG&#39;, 929), (&#39;airplane&#39;, 23), (&#39;car&#39;, 11), (&#39;person&#39;, 37)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display a random sample of proposals.</span>
<span class="c1"># Proposals classified as background are dotted, and</span>
<span class="c1"># the rest show their class and confidence score.</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limit</span><span class="p">)</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">ixs</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span>
                     <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROIs Before Refinement&quot;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/f4b61216324322f8e0314cc64ef6974cf4b98bb803c94cc216d5bdfa2c54066e.png" src="../../../../../_images/f4b61216324322f8e0314cc64ef6974cf4b98bb803c94cc216d5bdfa2c54066e.png" />
</div>
</div>
<section id="apply-bounding-box-refinement">
<h3>Apply Bounding Box Refinement<a class="headerlink" href="#apply-bounding-box-refinement" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Class-specific bounding box shifts.</span>
<span class="n">roi_bbox_specific</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;deltas&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;roi_bbox_specific&quot;</span><span class="p">,</span> <span class="n">roi_bbox_specific</span><span class="p">)</span>

<span class="c1"># Apply bounding box transformations</span>
<span class="c1"># Shape: [N, (y1, x1, y2, x2)]</span>
<span class="n">refined_proposals</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">apply_box_deltas</span><span class="p">(</span>
    <span class="n">proposals</span><span class="p">,</span> <span class="n">roi_bbox_specific</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">BBOX_STD_DEV</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;refined_proposals&quot;</span><span class="p">,</span> <span class="n">refined_proposals</span><span class="p">)</span>

<span class="c1"># Show positive proposals</span>
<span class="c1"># ids = np.arange(roi_boxes.shape[0])  # Display all</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi_positive_ixs</span><span class="p">),</span> <span class="n">limit</span><span class="p">)</span>  <span class="c1"># Display random sample</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span>
                     <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_proposals</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span>
                     <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                     <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROIs After Refinement&quot;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>roi_bbox_specific        shape: (1000, 4)             min:   -2.44748  max:    2.94838
refined_proposals        shape: (1000, 4)             min:   -8.00000  max: 1028.00000
</pre></div>
</div>
<img alt="../../../../../_images/f97332560d5cabdbb2ee24a0a535ab4ae7f3761646b71c791f7e780cff8e647e.png" src="../../../../../_images/f97332560d5cabdbb2ee24a0a535ab4ae7f3761646b71c791f7e780cff8e647e.png" />
</div>
</div>
</section>
<section id="filter-low-confidence-detections">
<h3>Filter Low Confidence Detections<a class="headerlink" href="#filter-low-confidence-detections" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove boxes classified as background</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keep </span><span class="si">{}</span><span class="s2"> detections:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Keep 71 detections:
[  0   2   3   4   5   6   8   9  16  17  18  19  25  30  36  37  38  40
  42  50  51  67  68  74  78  79  92 158 162 177 187 191 209 225 261 284
 292 314 328 374 402 403 409 429 473 490 499 516 545 557 572 575 607 624
 638 639 671 703 719 744 753 754 778 790 813 815 848 862 865 876 911]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove low confidence detections</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_scores</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_MIN_CONFIDENCE</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remove boxes below </span><span class="si">{}</span><span class="s2"> confidence. Keep </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_MIN_CONFIDENCE</span><span class="p">,</span> <span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Remove boxes below 0.5 confidence. Keep 67:
[  0   2   4   5   6   8   9  16  17  18  19  25  30  36  37  38  40  42
  50  51  67  68  74  78  79 158 162 177 187 191 209 225 284 292 314 328
 374 402 403 409 429 473 490 499 516 545 557 575 607 624 638 639 671 703
 719 744 753 754 778 790 813 815 848 862 865 876 911]
</pre></div>
</div>
</div>
</div>
</section>
<section id="per-class-non-max-suppression">
<h3>Per-Class Non-Max Suppression<a class="headerlink" href="#per-class-non-max-suppression" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply per-class non-max suppression</span>
<span class="n">pre_nms_boxes</span> <span class="o">=</span> <span class="n">refined_proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<span class="n">pre_nms_scores</span> <span class="o">=</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<span class="n">pre_nms_class_ids</span> <span class="o">=</span> <span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

<span class="n">nms_keep</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pre_nms_class_ids</span><span class="p">):</span>
    <span class="c1"># Pick detections of this class</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pre_nms_class_ids</span> <span class="o">==</span> <span class="n">class_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Apply NMS</span>
    <span class="n">class_keep</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">non_max_suppression</span><span class="p">(</span><span class="n">pre_nms_boxes</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> 
                                            <span class="n">pre_nms_scores</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span>
                                            <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_NMS_THRESHOLD</span><span class="p">)</span>
    <span class="c1"># Map indicies</span>
    <span class="n">class_keep</span> <span class="o">=</span> <span class="n">keep</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">class_keep</span><span class="p">]]</span>
    <span class="n">nms_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">nms_keep</span><span class="p">,</span> <span class="n">class_keep</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:22}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">class_id</span><span class="p">][:</span><span class="mi">20</span><span class="p">],</span> 
                                   <span class="n">keep</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">class_keep</span><span class="p">))</span>

<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">nms_keep</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kept after per-class NMS: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>person                : [  0   2   5   6   9  67  68  74  79 158 162 187 191 225 284 374 403 409
 429 490 545 557 575 607 638 671 703 744 753 754 778 790 813 848 862 876
 911] -&gt; [  0 162   9   2 671]
car                   : [ 16  18  30  36  51 177 314 328 499 624 815] -&gt; [30]
airplane              : [  4   8  17  19  25  37  38  40  42  50  78 209 292 402 473 516 639 719
 865] -&gt; [78 19]

Kept after per-class NMS: 8
[  0   2   9  19  30  78 162 671]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show final detections</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span>  <span class="c1"># Display all</span>
<span class="c1"># ixs = np.random.randint(0, len(keep), 10)  # Display random sample</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span>
    <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span>
    <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Detections after NMS&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/a8ce82792cb9bf51396fdc2f52456e241d7d787f9700468181c2d880c031acd2.png" src="../../../../../_images/a8ce82792cb9bf51396fdc2f52456e241d7d787f9700468181c2d880c031acd2.png" />
</div>
</div>
</section>
</section>
</section>
<section id="stage-3-generating-masks">
<h1>Stage 3: Generating Masks<a class="headerlink" href="#stage-3-generating-masks" title="Link to this heading">#</a></h1>
<p>This stage takes the detections (refined bounding boxes and class IDs) from the previous layer and runs the mask head to generate segmentation masks for every instance.</p>
<section id="a-mask-targets">
<h2>3.a Mask Targets<a class="headerlink" href="#a-mask-targets" title="Link to this heading">#</a></h2>
<p>These are the training targets for the mask branch</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">gt_mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/44dfa209830d2e7b4245c138970250fbc04ac43114e8ddd52bfc0eeb305d7e8c.png" src="../../../../../_images/44dfa209830d2e7b4245c138970250fbc04ac43114e8ddd52bfc0eeb305d7e8c.png" />
</div>
</div>
</section>
<section id="b-predicted-masks">
<h2>3.b Predicted Masks<a class="headerlink" href="#b-predicted-masks" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get predictions of mask head</span>
<span class="n">mrcnn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;detections&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_detection&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># Get detection class IDs. Trim zero padding.</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">det_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">det_class_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">det_class_ids</span><span class="p">[:</span><span class="n">det_count</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> detections: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">det_count</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">det_class_ids</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>detections               shape: (1, 100, 6)           min:    0.00000  max:  844.00000
masks                    shape: (1, 100, 28, 28, 81)  min:    0.00000  max:    0.99984
8 detections: [&#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;airplane&#39; &#39;airplane&#39; &#39;car&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Masks</span>
<span class="n">det_boxes</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;detections&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">det_mask_specific</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> 
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">det_class_ids</span><span class="p">)])</span>
<span class="n">det_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">unmold_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">det_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">det_mask_specific</span><span class="p">)])</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;det_mask_specific&quot;</span><span class="p">,</span> <span class="n">det_mask_specific</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;det_masks&quot;</span><span class="p">,</span> <span class="n">det_masks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>det_mask_specific        shape: (8, 28, 28)           min:    0.00001  max:    0.99984
det_masks                shape: (8, 1024, 1024)       min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">det_mask_specific</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/3fd8640f23297b94a6745a8848bffb1fb21e48ea5f65ff82bef1c7aecd789a23.png" src="../../../../../_images/3fd8640f23297b94a6745a8848bffb1fb21e48ea5f65ff82bef1c7aecd789a23.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">det_masks</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/04903d3ffe849406020e2b7408abb60c1ca5fff7e448d8ac35684bbcbad01235.png" src="../../../../../_images/04903d3ffe849406020e2b7408abb60c1ca5fff7e448d8ac35684bbcbad01235.png" />
</div>
</div>
</section>
</section>
<section id="visualize-activations">
<h1>Visualize Activations<a class="headerlink" href="#visualize-activations" title="Link to this heading">#</a></h1>
<p>In some cases it helps to look at the output from different layers and visualize them to catch issues and odd patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get activations of a few sample layers</span>
<span class="n">activations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;input_image&quot;</span><span class="p">,</span>        <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;input_image&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">,</span>          <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>  <span class="c1"># for resnet100</span>
    <span class="p">(</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">,</span>           <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;roi&quot;</span><span class="p">,</span>                <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>input_image              shape: (1, 1024, 1024, 3)    min: -123.70000  max:  151.10001
res4w_out                shape: (1, 64, 64, 1024)     min:    0.00000  max:   54.64681
rpn_bbox                 shape: (1, 65472, 4)         min:  -12.26412  max:   18.18265
roi                      shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input image (normalized)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">modellib</span><span class="o">.</span><span class="n">unmold_image</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;input_image&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/f2d9a40d73c74782fefbf69372614783f0bc596f2fb00a550134750a1fddee6e.png" src="../../../../../_images/f2d9a40d73c74782fefbf69372614783f0bc596f2fb00a550134750a1fddee6e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backbone feature map</span>
<span class="n">display_images</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:,:</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/0d7c1b1da7f8ff571ec0b9c8f455d613a4b2471ca9c96ac1249dc701cba376bb.png" src="../../../../../_images/0d7c1b1da7f8ff571ec0b9c8f455d613a4b2471ca9c96ac1249dc701cba376bb.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histograms of RPN bounding box deltas</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dw&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dh&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">3</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/98c7b08626fa579c9b2fc9cfdad2a394d38214efeb9bbed06e76ca34576ec170.png" src="../../../../../_images/98c7b08626fa579c9b2fc9cfdad2a394d38214efeb9bbed06e76ca34576ec170.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Distribution of y, x coordinates of generated proposals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;y1, x1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;y2, x2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/adfef37a30dc1e1fda0f6fabf5280219ce8cddbdc6a89e12cbe4a2ffde460d5f.png" src="../../../../../_images/adfef37a30dc1e1fda0f6fabf5280219ce8cddbdc6a89e12cbe4a2ffde460d5f.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "pantelis/artificial-intelligence",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="inspect_data.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mask R-CNN - Inspect Training Data</p>
      </div>
    </a>
    <a class="right-next"
       href="inspect_weights.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Mask R-CNN - Inspect Weights of a Trained Model</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Mask R-CNN - Inspect Trained Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#configurations">Configurations</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#notebook-preferences">Notebook Preferences</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-validation-dataset">Load Validation Dataset</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-model">Load Model</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#run-detection">Run Detection</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#precision-recall">Precision-Recall</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-map-iou-50-on-batch-of-images">Compute mAP @ IoU=50 on Batch of Images</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#step-by-step-prediction">Step by Step Prediction</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-1-region-proposal-network">Stage 1: Region Proposal Network</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-rpn-targets">1.a RPN Targets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-rpn-predictions">1.b RPN Predictions</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-2-proposal-classification">Stage 2: Proposal Classification</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-proposal-classification">2.a Proposal Classification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-step-by-step-detection">2.c Step by Step Detection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-bounding-box-refinement">Apply Bounding Box Refinement</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-low-confidence-detections">Filter Low Confidence Detections</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#per-class-non-max-suppression">Per-Class Non-Max Suppression</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-3-generating-masks">Stage 3: Generating Masks</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-mask-targets">3.a Mask Targets</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-predicted-masks">3.b Predicted Masks</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visualize-activations">Visualize Activations</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Pantelis Monogioudis, Ph.D
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>